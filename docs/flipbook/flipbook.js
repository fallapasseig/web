import"./flipbook.css";export class Flipbook{constructor(t){if(this.target="string"==typeof t.target?document.querySelector(t.target):t.target,!this.target)throw new Error("Target element not found");this.images=t.images||[],this.duration=t.duration||800,this.bufferSize=t.bufferSize||4,this.destroyed=!1,this.boundKeyDown=this.handleKeyDown.bind(this),this.boundClickHandler=this.handleClick.bind(this),this.opts=t,this.singlePage=!0===t.singlePage,this.useKeyboard=!1!==t.useKeyboard,this.sheetCount=Math.ceil(this.images.length/2),this.sheetElements=new Map,this.currentPage=1,this.bookWidth=t.width||800,this.bookHeight=t.height||600,this.init(),this.useKeyboard&&document.addEventListener("keydown",this.boundKeyDown),!t.width&&!t.height&&this.images.length>0&&this.detectRatio(),this.resizeObserver=new ResizeObserver((()=>this.resize())),this.resizeObserver.observe(this.target)}detectRatio(){const t=new Image;t.onload=()=>{if(this.destroyed)return;const e=t.naturalWidth/t.naturalHeight;this.bookHeight=1e3,this.bookWidth=2*this.bookHeight*e,this.book&&(this.book.style.width=`${this.bookWidth}px`,this.book.style.height=`${this.bookHeight}px`),this.updateState(),this.resize()},t.src=this.images[0]}handleKeyDown(t){"ArrowRight"===t.key?this.nextPage():"ArrowLeft"===t.key&&this.prevPage()}handleClick(t){const e=this.target.getBoundingClientRect();t.clientX-e.left<e.width/2?this.prevPage():this.nextPage()}createSheet(t){if(this.sheetElements.has(t))return;const e=document.createElement("div");e.classList.add("flipbook-page"),e.setAttribute("data-sheet-index",t);const s=2*t,i=2*t+1,h=document.createElement("div");h.classList.add("flipbook-page-front"),this.images[s]&&(h.style.backgroundImage=`url('${this.images[s]}')`);const a=document.createElement("div");a.classList.add("flipbook-page-back"),this.images[i]&&(a.style.backgroundImage=`url('${this.images[i]}')`),e.appendChild(h),e.appendChild(a);t<this.getSheetsToFlipCount()&&e.classList.add("flipped");const n=this.book.querySelectorAll(".flipbook-page");let o=!1;for(const s of n){if(parseInt(s.getAttribute("data-sheet-index"),10)>t){this.book.insertBefore(e,s),o=!0;break}}o||this.book.appendChild(e),this.sheetElements.set(t,{sheet:e,front:h,back:a})}removeSheet(t){const e=this.sheetElements.get(t);e&&(e.sheet.remove(),this.sheetElements.delete(t))}updateVirtualWindow(){const t=Math.floor((this.currentPage-1)/2),e=Math.max(0,t-this.bufferSize),s=Math.min(this.sheetCount-1,t+this.bufferSize);for(const t of this.sheetElements.keys())(t<e||t>s)&&this.removeSheet(t);for(let t=e;t<=s;t++)this.createSheet(t)}getSheetsToFlipCount(){return this.currentPage%2!=0?Math.floor((this.currentPage-1)/2):Math.floor((this.currentPage-1)/2)+1}init(){this.target.classList.add("flipbook-stage"),this.book=document.createElement("div"),this.book.classList.add("flipbook-book"),this.book.style.width=`${this.bookWidth}px`,this.book.style.height=`${this.bookHeight}px`,this.book.style.setProperty("--page-duration",`${this.duration}ms`),this.target.appendChild(this.book),this.target.addEventListener("click",this.boundClickHandler),this.updateState(),this.resize()}setSinglePageMode(t){this.singlePage!==t&&(this.singlePage=t,this.updateState(),this.resize())}resize(){const t=this.target.clientWidth,e=this.target.clientHeight;if(!t||!e)return;const s=t<1800;let i,h;"auto"===this.opts.singlePage?s!==this.singlePage&&(this.singlePage=s,this.target.classList.toggle("single-page",this.singlePage),this.target.classList.toggle("double-page",!this.singlePage),this.updateState()):s&&!this.singlePage?(this.singlePage=!0,this.target.classList.toggle("single-page",this.singlePage),this.target.classList.toggle("double-page",!this.singlePage),this.updateState()):s||"auto"===this.opts.singlePage||this.singlePage===this.opts.singlePage?(this.target.classList.toggle("single-page",this.singlePage),this.target.classList.toggle("double-page",!this.singlePage)):(this.singlePage=!0===this.opts.singlePage,this.target.classList.toggle("single-page",this.singlePage),this.target.classList.toggle("double-page",!this.singlePage),this.updateState()),this.singlePage?(i=this.bookWidth/2,h=this.bookHeight):(i=this.bookWidth,h=this.bookHeight);const a=t/i,n=e/h;let o;o=this.singlePage?a:.95*Math.min(a,n),this.currentScale=o,this.updateTransform()}updateTransform(){const t=this.currentPanX||0;this.book.style.transform=`scale(${this.currentScale}) translateX(${t}px)`}nextPage(){this.singlePage?this.currentPage<this.images.length&&(this.currentPage++,this.updateState()):(1===this.currentPage?this.currentPage=2:this.currentPage+2<=this.images.length?this.currentPage+=2:this.currentPage<this.images.length&&this.currentPage%2==0&&(this.currentPage+=1),this.updateState())}prevPage(){this.singlePage?this.currentPage>1&&(this.currentPage--,this.updateState()):this.currentPage>2?(this.currentPage-=2,this.currentPage<1&&(this.currentPage=1),this.updateState()):2===this.currentPage&&(this.currentPage=1,this.updateState())}goToPage(t){this.currentPage=Math.max(1,Math.min(t,this.images.length)),this.updateState()}updateState(){const t=this.getSheetsToFlipCount();this.updateVirtualWindow();for(const[e,s]of this.sheetElements)e<t?s.sheet.classList.add("flipped"):s.sheet.classList.remove("flipped");this.updateZIndexes(),this.singlePage?this.currentPage%2==0?this.currentPanX=this.bookWidth/4:this.currentPanX=-this.bookWidth/4:1===this.currentPage?this.currentPanX=-this.bookWidth/4:this.currentPage===this.images.length&&this.currentPage%2==0?this.currentPanX=this.bookWidth/4:this.currentPanX=0,this.updateTransform()}updateZIndexes(){const t=this.sheetCount;for(const[e,s]of this.sheetElements)s.sheet.classList.contains("flipped")?s.sheet.style.zIndex=e+1:s.sheet.style.zIndex=t-e}destroy(){this.destroyed||(this.destroyed=!0,this.resizeObserver&&this.resizeObserver.disconnect(),this.useKeyboard&&document.removeEventListener("keydown",this.boundKeyDown),this.target&&this.target.removeEventListener("click",this.boundClickHandler),this.target&&this.book&&this.target.removeChild(this.book),this.sheetElements.clear(),this.sheetElements=null,this.images=null,this.book=null,this.target=null,this.boundKeyDown=null,this.boundClickHandler=null,this.resizeObserver=null)}}