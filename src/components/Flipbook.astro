---
interface Props {
  baseUrl: string;
  imageFiles: string[];
}

const { baseUrl, imageFiles } = Astro.props;
---

<div id="flipbook-viewport" data-base-url={baseUrl}>
  <div id="flipbook-container">
    <div id="flipbook">
      {imageFiles.map((file) => <div class="page" style={`background-image:url(${baseUrl}${file})`} />)}
    </div>
  </div>
  <div id="nav-controls">
    <button id="prev-btn" aria-label="Pàgina anterior">&#9664;</button>
    <span id="page-display"></span>
    <button id="next-btn" aria-label="Pàgina següent">&#9654;</button>
  </div>
</div>

<style is:global>
  #flipbook-viewport {
    width: 100%;
    height: calc(100vh - 80px);
    position: relative;
    overflow: hidden;
    background: #1a1a1a;
    -webkit-user-select: none;
    user-select: none;
  }

  #flipbook-container {
    position: absolute;
    top: 50%;
    left: 50%;
    transform-origin: center center;
  }

  #flipbook .page {
    background-size: contain;
    background-position: center;
    background-repeat: no-repeat;
    background-color: #fff;
    cursor: pointer;
    overflow: hidden;
  }

  #nav-controls {
    position: absolute;
    bottom: 15px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 12px;
    z-index: 100;
    background: rgba(0, 0, 0, 0.55);
    padding: 8px 16px;
    border-radius: 24px;
    -webkit-backdrop-filter: blur(4px);
    backdrop-filter: blur(4px);
  }

  #nav-controls button {
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
    color: #333;
    line-height: 1;
  }

  #nav-controls button:hover {
    background: #fff;
  }

  #nav-controls button:disabled {
    opacity: 0.4;
    cursor: default;
  }

  #page-display {
    color: #fff;
    font-size: 13px;
    min-width: 70px;
    text-align: center;
    font-family: monospace;
  }
</style>

<script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script is:inline src="/web/turnjs/turn.html4.min.js"></script>
<script is:inline>
  $(function () {
    const SINGLE_PAGE_WIDTH = 900;
    var $book = $('#flipbook');
    var $container = $('#flipbook-container');
    var $viewport = $('#flipbook-viewport');
    var BASE_URL = $viewport.attr('data-base-url');
    var isMobile = 'ontouchstart' in window;
    var programmaticTurn = false;

    // Load first image to get its native dimensions for turn.js init
    var probe = new Image();
    probe.onload = function () {
      initFlipbook(probe.naturalWidth * 2, probe.naturalHeight);
    };
    probe.onerror = function () {
      initFlipbook(2828, 2000);
    };
    probe.src = BASE_URL + '0000.jpg';

    function initFlipbook(BOOK_WIDTH, BOOK_HEIGHT) {
      $book.turn({
        width: BOOK_WIDTH,
        height: BOOK_HEIGHT,
        autoCenter: false,
        acceleration: true,
        gradients: true,
        elevation: 50,
        duration: 800,
        display: $(window).width() < SINGLE_PAGE_WIDTH ? 'single' : 'double',
        when: {
          turning: function (e) {
            if (isMobile && !programmaticTurn) {
              e.preventDefault();
            }
            programmaticTurn = false;
          },
          turned: function () {
            updatePageDisplay();
            updateButtons();
          },
        },
      });

      $(window).on('resize', resize);
      resize();
    }

    function updatePageDisplay() {
      var page = $book.turn('page');
      var pages = $book.turn('pages');
      $('#page-display').text(page + ' / ' + pages);
    }

    function updateButtons() {
      var page = $book.turn('page');
      var pages = $book.turn('pages');
      $('#prev-btn').prop('disabled', page <= 1);
      $('#next-btn').prop('disabled', page >= pages);
    }

    function resize() {
      var vW = $viewport.width();
      var vH = $viewport.height();

      var mode = vW < SINGLE_PAGE_WIDTH ? 'single' : 'double';

      if ($book.turn('display') !== mode) {
        $book.turn('display', mode);
      }

      var bW = $book.width();
      var bH = $book.height();

      var scaleX = vW / bW;
      var scaleY = vH / bH;
      var scale;

      if (mode === 'single') {
        // bW is the full double-spread width; one visible page is half
        scale = Math.min(vW / (bW / 2), vH / bH) * 0.92;
      } else {
        scale = Math.min(scaleX, scaleY) * 0.92;
      }

      $container.css({
        width: bW,
        height: bH,
        transform: 'translate(-50%, -50%) scale(' + scale + ')',
      });

      updatePageDisplay();
      updateButtons();
    }

    // Navigation buttons
    $('#prev-btn').on('click', function (e) {
      e.stopPropagation();
      programmaticTurn = true;
      $book.turn('previous');
    });

    $('#next-btn').on('click', function (e) {
      e.stopPropagation();
      programmaticTurn = true;
      $book.turn('next');
    });

    // Keyboard navigation
    $(document).on('keydown', function (e) {
      if (e.keyCode === 37) {
        programmaticTurn = true;
        $book.turn('previous');
      } else if (e.keyCode === 39) {
        programmaticTurn = true;
        $book.turn('next');
      }
    });

    // Touch swipe support
    var touchStartX = 0;
    var touchStartY = 0;

    $viewport[0].addEventListener(
      'touchstart',
      function (e) {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
      },
      { passive: true }
    );

    $viewport[0].addEventListener(
      'touchend',
      function (e) {
        var dx = e.changedTouches[0].clientX - touchStartX;
        var dy = e.changedTouches[0].clientY - touchStartY;

        if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 50) {
          programmaticTurn = true;
          if (dx > 0) {
            $book.turn('previous');
          } else {
            $book.turn('next');
          }
        }
      },
      { passive: true }
    );
  });
</script>
